<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.o2.metadata.core.infra.mapper.PosRelCarrierMapper">
    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap id="BaseResultMap" type="org.o2.metadata.core.domain.entity.PosRelCarrier">
        <result column="pos_rel_carrier_id" property="posRelCarrierId" jdbcType="DECIMAL"/>
        <result column="carrier_id" property="carrierId" jdbcType="DECIMAL"/>
        <result column="pos_id" property="posId" jdbcType="DECIMAL"/>
        <result column="active_flag" property="activeFlag" jdbcType="DECIMAL"/>
        <result column="default_flag" property="defaultFlag" jdbcType="DECIMAL"/>
        <result column="priority" property="priority" jdbcType="DECIMAL"/>
        <result column="carrier_name" property="carrierName" jdbcType="VARCHAR"/>
        <result column="OBJECT_VERSION_NUMBER" property="objectVersionNumber" jdbcType="DECIMAL"/>
        <result column="CREATION_DATE" property="creationDate" jdbcType="TIMESTAMP"/>
        <result column="CREATED_BY" property="createdBy" jdbcType="DECIMAL"/>
        <result column="LAST_UPDATED_BY" property="lastUpdatedBy" jdbcType="DECIMAL"/>
        <result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP"/>
        <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
    </resultMap>

    <select id="listCarrierWithPos" resultMap="BaseResultMap">
        SELECT
        t.pos_rel_carrier_id,
        t.carrier_id,
        t.pos_id,
        t.active_flag,
        t.default_flag,
        t.priority,
        t.OBJECT_VERSION_NUMBER,
        c.carrier_name
        FROM
        o2md_pos_rel_carrier t
        JOIN o2md_carrier c ON t.carrier_id = c.carrier_id
        where 1=1
        <choose>
            <when test="tenantId != null">
                and t.tenant_id = #{tenantId}
            </when>
            <otherwise>
                AND t.tenant_id = 0
            </otherwise>
        </choose>
            <if test="posId != null">
                and t.pos_id = #{posId}
            </if>
            <if test="carrierId != null">
                and t.carrier_id = #{carrierId}
            </if>
            <if test="carrierName != null and carrierName != ''">
                <bind name="carrierNameLike" value="'%' + carrierName + '%'"/>
                and c.carrier_name like #{carrierNameLike}
            </if>
        ORDER BY priority
    </select>

    <select id="isExist" resultType="int">
        SELECT
        (
        CASE
        WHEN (
        SELECT
        COUNT(1)
        FROM
        o2md_pos_rel_carrier t
        WHERE
        t.pos_id = #{posId}
        AND t.carrier_id = #{carrierId}
        <if test="posRelCarrierId != null">
            and t.pos_rel_carrier_id != #{posRelCarrierId}
        </if>
        ) > 0 THEN
        1
        WHEN (
        SELECT
        COUNT(1)
        FROM
        o2md_pos_rel_carrier t
        WHERE
        t.pos_id = #{posId}
        AND t.priority = #{priority}
        <if test="posRelCarrierId != null">
            and t.pos_rel_carrier_id != #{posRelCarrierId}
        </if>
        ) > 0 THEN
        2
        ELSE
        0
        END
        ) AS num
        FROM
        DUAL
    </select>

    <update id="updateIsDefault" parameterType="java.lang.Long">
        UPDATE o2md_pos_rel_carrier t
        SET t.default_flag = 0
        ,t.OBJECT_VERSION_NUMBER=OBJECT_VERSION_NUMBER+1
        WHERE
            t.pos_rel_carrier_id != #{relId, jdbcType=DECIMAL}
            and t.pos_id = #{posId, jdbcType=DECIMAL}
    </update>

</mapper>